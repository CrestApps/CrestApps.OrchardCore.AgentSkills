name: Release - CI
on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    runs-on: ${{ matrix.os }}
    name: Build, Test, Deploy
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
    - name: Get the version
      id: get_version
      run: |
        arrTag=(${GITHUB_REF//\// })
        VERSION="${arrTag[2]}"
        VERSION="${VERSION//v}"
        echo VERSION:${VERSION}
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
      shell: bash
    - uses: actions/checkout@v4
    - uses: actions/setup-dotnet@v4
      with:
        dotnet-version: |
          10.0.x
    - name: Set build number
      if: matrix.os == 'ubuntu-latest'
      run: echo "BuildNumber=$(( $GITHUB_RUN_NUMBER ))" >> $GITHUB_ENV
    - name: Build
      run: |
        dotnet build -c Release -warnaserror /p:TreatWarningsAsErrors=true /p:RunAnalyzers=true -p:Version=${{ steps.get_version.outputs.VERSION }}
    - name: Test
      run: |
        dotnet test -c Release --no-build --verbosity normal
    - name: Validate SKILL.md files
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        SKILLS_BASE_DIR="src/CrestApps.AgentSkills.Skills"
        EXIT_CODE=0

        if [ ! -d "$SKILLS_BASE_DIR" ]; then
          echo "::error::Skills base directory not found: $SKILLS_BASE_DIR"
          exit 1
        fi

        # Find all framework directories (e.g., orchardcore, aspnetcore, etc.)
        # Exclude bin and obj folders
        FRAMEWORK_DIRS=$(find "$SKILLS_BASE_DIR" -mindepth 1 -maxdepth 1 -type d ! -name "bin" ! -name "obj")
        
        if [ -z "$FRAMEWORK_DIRS" ]; then
          echo "::error::No framework directories found in $SKILLS_BASE_DIR"
          exit 1
        fi

        # Iterate through each framework directory
        for framework_dir in $FRAMEWORK_DIRS; do
          framework_name=$(basename "$framework_dir")
          echo "Validating skills for framework: $framework_name"

          # Iterate through each skill in the framework directory
          for skill_dir in "$framework_dir"/*/; do
            [ -d "$skill_dir" ] || continue
            skill_name=$(basename "$skill_dir")

            # Check SKILL.md exists.
            if [ ! -f "$skill_dir/SKILL.md" ]; then
              echo "::error file=$skill_dir::Skill '$framework_name/$skill_name' is missing SKILL.md"
              EXIT_CODE=1
              continue
            fi

            # Validate front-matter structure.
            # Must start with ---.
            FIRST_LINE=$(head -1 "$skill_dir/SKILL.md")
            if [ "$FIRST_LINE" != "---" ]; then
              echo "::error file=${skill_dir}SKILL.md::Skill '$framework_name/$skill_name' SKILL.md must start with '---' front-matter delimiter"
              EXIT_CODE=1
              continue
            fi

            # Must have closing ---.
            CONTENT=$(cat "$skill_dir/SKILL.md")
            CLOSING_LINE=$(echo "$CONTENT" | tail -n +2 | grep -n "^---$" | head -1 | cut -d: -f1)
            if [ -z "$CLOSING_LINE" ]; then
              echo "::error file=${skill_dir}SKILL.md::Skill '$framework_name/$skill_name' SKILL.md is missing closing '---' front-matter delimiter"
              EXIT_CODE=1
              continue
            fi

            # Extract front-matter (between the two --- lines).
            FRONT_MATTER=$(echo "$CONTENT" | sed -n "2,$((CLOSING_LINE))p")

            # Check required 'name' field.
            if ! echo "$FRONT_MATTER" | grep -q "^name:"; then
              echo "::error file=${skill_dir}SKILL.md::Skill '$framework_name/$skill_name' SKILL.md is missing required 'name' field in front-matter"
              EXIT_CODE=1
            fi

            # Check required 'description' field.
            if ! echo "$FRONT_MATTER" | grep -q "^description:"; then
              echo "::error file=${skill_dir}SKILL.md::Skill '$framework_name/$skill_name' SKILL.md is missing required 'description' field in front-matter"
              EXIT_CODE=1
            fi

            # Validate directory name matches skill name.
            SKILL_NAME_VALUE=$(echo "$FRONT_MATTER" | grep "^name:" | sed 's/^name:[[:space:]]*//')
            if [ "$SKILL_NAME_VALUE" != "$skill_name" ]; then
              echo "::error file=${skill_dir}SKILL.md::Skill name '$SKILL_NAME_VALUE' in front-matter does not match directory name '$skill_name' for '$framework_name/$skill_name'"
              EXIT_CODE=1
            fi

            # Check that no old-format files exist.
            if [ -f "$skill_dir/skill.yaml" ]; then
              echo "::error file=${skill_dir}skill.yaml::Skill '$framework_name/$skill_name' contains deprecated skill.yaml file. Use SKILL.md with front-matter instead."
              EXIT_CODE=1
            fi
            if [ -f "$skill_dir/prompts.md" ]; then
              echo "::error file=${skill_dir}prompts.md::Skill '$framework_name/$skill_name' contains deprecated prompts.md file. Merge content into SKILL.md."
              EXIT_CODE=1
            fi

            echo "âœ“ $framework_name/$skill_name"
          done
        done

        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "::error::One or more skills failed validation. See errors above."
        else
          echo ""
          echo "All skills passed validation."
        fi

        exit $EXIT_CODE
    - name: Validate skill packaging includes files
      if: matrix.os == 'ubuntu-latest'
      shell: bash
      run: |
        validate_project() {
          local project="$1"
          local include_path="$2"
          local package_path="$3"

          if [ ! -f "$project" ]; then
            echo "::error file=$project::Project file not found."
            exit 1
          fi

          if ! grep -Fq "$include_path" "$project"; then
            echo "::error file=$project::Missing skills include path '$include_path'."
            exit 1
          fi

          if ! grep -Fq "$package_path" "$project"; then
            echo "::error file=$project::Missing skills package path '$package_path'."
            exit 1
          fi
        }

        validate_project \
          "src/CrestApps.OrchardCore.AgentSkills/CrestApps.OrchardCore.AgentSkills.csproj" \
          '..\CrestApps.AgentSkills.Skills\orchardcore\**\*' \
          'PackagePath="skills"'

        validate_project \
          "src/CrestApps.OrchardCore.AgentSkills.Mcp/CrestApps.OrchardCore.AgentSkills.Mcp.csproj" \
          '..\CrestApps.AgentSkills.Skills\orchardcore\**\*' \
          'PackagePath="contentFiles\any\any\.agents\skills"'
    - name: Deploy release NuGet packages
      if: matrix.os == 'ubuntu-latest'
      run: |
        dotnet pack -c Release --no-build -p:Version=${{ steps.get_version.outputs.VERSION }} -p:TreatWarningsAsErrors=false
        dotnet nuget push './src/**/*.nupkg' -t 600 -k ${{secrets.NUGET_API_KEY}} -s https://api.nuget.org/v3/index.json --skip-duplicate
