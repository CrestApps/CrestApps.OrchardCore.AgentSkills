name: Preview - CI
on:
  workflow_dispatch:
  schedule:
    # 4:19 AM UTC every day. A random time to avoid peak times of GitHub Actions.
    - cron: '19 4 * * *'

permissions:
  contents: read

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  test:
    runs-on: ubuntu-latest
    name: Build, Test, Deploy
    steps:
    - uses: actions/checkout@v4
    - name: Check if should publish
      id: check-publish
      shell: pwsh
      run: |
        $hasCommitFromLastDay = ![string]::IsNullOrEmpty((git log --oneline --since '24 hours ago'))
        Write-Output "Commits found in the last 24 hours: $hasCommitFromLastDay."
        $shouldPublish = ($hasCommitFromLastDay -and '${{ github.event_name }}' -eq 'schedule') -or ('${{ github.event_name }}' -eq 'workflow_dispatch')
        "should-publish=$($shouldPublish ? 'true' : 'false')" >> $Env:GITHUB_OUTPUT
    - uses: actions/setup-dotnet@v4
      if: steps.check-publish.outputs.should-publish == 'true'
      with:
        dotnet-version: |
          10.0.x
    - name: Set build number
      if: steps.check-publish.outputs.should-publish == 'true'
      run: echo "BuildNumber=$(( $GITHUB_RUN_NUMBER ))" >> $GITHUB_ENV
    - name: Build
      if: steps.check-publish.outputs.should-publish == 'true'
      run: |
        dotnet build -c Release -warnaserror /p:TreatWarningsAsErrors=true /p:RunAnalyzers=true /p:NuGetAudit=false
    - name: Test
      if: steps.check-publish.outputs.should-publish == 'true'
      run: |
        dotnet test -c Release --no-build --verbosity normal
    - uses: actions/setup-python@v5
      if: steps.check-publish.outputs.should-publish == 'true'
      with:
        python-version: '3.12'
    - name: Install skills-ref
      if: steps.check-publish.outputs.should-publish == 'true'
      run: |
        python -m pip install --upgrade pip
        python -m pip install "git+https://github.com/agentskills/agentskills.git@main#subdirectory=skills-ref"
    - name: Validate SKILL.md files
      if: steps.check-publish.outputs.should-publish == 'true'
      shell: bash
      run: |
        SKILLS_BASE_DIR=".agents/skills"
        SKILLS_SOURCE_DIR="src/CrestApps.AgentSkills.Skills"
        EXIT_CODE=0

        if [ ! -d "$SKILLS_BASE_DIR" ]; then
          if [ -d "$SKILLS_SOURCE_DIR" ]; then
            mkdir -p "$SKILLS_BASE_DIR"
            while IFS= read -r -d '' skill_file; do
              source_dir="$(dirname "$skill_file")"
              relative_dir="${source_dir#$SKILLS_SOURCE_DIR/}"
              destination_dir="$SKILLS_BASE_DIR/$relative_dir"
              mkdir -p "$destination_dir"
              cp -R "$source_dir"/. "$destination_dir"
            done < <(find "$SKILLS_SOURCE_DIR" -type d \( -name "bin" -o -name "obj" \) -prune -o -type f -name "SKILL.md" -print0)
          else
            echo "::error::Skills base directory not found: $SKILLS_BASE_DIR"
            exit 1
          fi
        fi

        while IFS= read -r -d '' skill_dir; do
          if ! skills-ref validate "$skill_dir"; then
            echo "::error file=$skill_dir/SKILL.md::skills-ref validation failed for $skill_dir"
            EXIT_CODE=1
          else
            echo "âœ“ $(basename "$skill_dir")"
          fi
        done < <(find "$SKILLS_BASE_DIR" -mindepth 2 -maxdepth 2 -type d ! -name "bin" ! -name "obj" -print0)

        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "::error::One or more skills failed validation. See errors above."
        else
          echo ""
          echo "All skills passed validation."
        fi

        exit $EXIT_CODE
    - name: Validate skill packaging includes files
      if: steps.check-publish.outputs.should-publish == 'true'
      shell: bash
      run: |
        validate_project() {
          local project="$1"
          local include_path="$2"
          local package_path="$3"
          local exclude_path="$4"

          if [ ! -f "$project" ]; then
            echo "::error file=$project::Project file not found."
            exit 1
          fi

          if ! grep -Fq "$include_path" "$project"; then
            echo "::error file=$project::Missing skills include path '$include_path'."
            exit 1
          fi

          if ! grep -Fq "$package_path" "$project"; then
            echo "::error file=$project::Missing skills package path '$package_path'."
            exit 1
          fi

          if [ -n "$exclude_path" ] && ! grep -Fq "$exclude_path" "$project"; then
            echo "::error file=$project::Missing skills exclude path '$exclude_path'."
            exit 1
          fi
        }

        validate_project \
          "src/CrestApps.OrchardCore.AgentSkills/CrestApps.OrchardCore.AgentSkills.csproj" \
          '..\CrestApps.AgentSkills.Skills\orchardcore\**\*' \
          'PackagePath="skills"' \
          'Exclude="..\CrestApps.AgentSkills.Skills\orchardcore\**\bin\**\*;..\CrestApps.AgentSkills.Skills\orchardcore\**\lib\**\*"'

        validate_project \
          "src/CrestApps.OrchardCore.AgentSkills.Mcp/CrestApps.OrchardCore.AgentSkills.Mcp.csproj" \
          '..\CrestApps.AgentSkills.Skills\orchardcore\**\*' \
          'PackagePath="contentFiles\any\any\.agents\skills"' \
          'Exclude="..\CrestApps.AgentSkills.Skills\orchardcore\**\bin\**\*;..\CrestApps.AgentSkills.Skills\orchardcore\**\lib\**\*"'
    - name: Deploy preview NuGet packages
      if: steps.check-publish.outputs.should-publish == 'true'
      run: |
        dotnet pack -c Release --no-build
        dotnet nuget push './src/**/*.nupkg' -t 600 -k ${{secrets.CLOUDSMITH_API_KEY}} -n -s https://nuget.cloudsmith.io/crestapps/crestapps-orchardcore/v3/index.json --skip-duplicate
